<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>P5LIVE Snippets</title>
	
	<script src="includes/js/beautify.min.js"></script>
	<script src="includes/js/popper.min.js"></script>
	<script src="includes/js/tippy.all.js"></script>
	<script src="includes/js/vex/js/vex.combined.min.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js" referrerpolicy="no-referrer"></script>	<script src="//ajaxorg.github.io/ace-builds/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

	<link rel="stylesheet" href="includes/js/vex/css/vex.css" />
	<link rel="stylesheet" href="includes/js/vex/css/vex-theme-plain.css" />
	<link rel="stylesheet" type="text/css" media="all" href="style.css?53">

	<style type="text/css">
	*{
		box-sizing: border-box;
	}
	</style>
</head>
<body>
	<div id="snippets-panel">
		<div class="snippets-bg"></div>
		<div id="snippets-content">
			<div class="menu-section">
				<div class="menu-section-bg"></div>
				<div class="menu-header">
					SNIPPETS MANAGER
					<div class="snippets-close tippy" data-title="Close Panel" onclick="snippetsToggle()">
						X
					</div>
				</div>
				<div class="menu-sketches-buttons">
					<select id="select-snippet" class="snippets-select menu-button tippy" onchange="getSnippet(this.value)" data-title="Select Snippet">
						<option value="snippet">Info</option>
					</select>
					
					<button class="menu-button snippets-btn-all tippy" onclick="applySnippet()" data-title="Apply Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check-square"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></button>

					<!-- <button class="menu-button snippets-btn-all tippy" onclick="snippetsImportDialog()" data-title="Import Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg></button>
					<input id="file-input-snippet" type="file" name="name" style="display: none;" multiple onchange="snippetsImport(this.files);" onclick="this.value=null;" /> -->
					
					<button class="menu-button snippets-btn-all tippy" onclick="downloadSnippet()" data-title="Export Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg></button>
					<input id="file-input-snippet" type="file" name="name" style="display: none;" multiple onchange="snippetsImport(this.files);" onclick="this.value=null;" />

					<button class="menu-button snippets-btn-all tippy" onclick="addSnippet()" data-title="Import Snippet"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>



				</div>
			</div>

			<!-- <div id="snippets-nav">
				
			</div> -->
			
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// global top </span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['gt'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-gt"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// setup bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['s'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-s"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// draw top</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['dt'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-dt"></pre>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// draw bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['db'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-db"></pre><br>
			</div>
			<div class="snippets-section">
				<div class="snippets-label">
					<span>// global bottom</span>
					<svg class="tippy" data-title="Tidy Code" onclick="tidyCode(snip.editors['gb'])" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-align-left"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
				</div>
				<pre id="snippets-code-gb"></pre>
			</div>
		</div>
	</div>

	<!-- <div id="nav">
		<span id="title">P5LIVE </span>
		<select id="select-snippet" onchange="getSnippet(this.value)">
			<option value="snippet">Snippets Manager</option>
		</select>
		<button id="button-add" class="button" onclick="addSnippet()">Add</button>
		<button id="button-download" class="button" onclick="downloadSnippet()">Export</button>
		<span></span>
	</div>

	<div id="code">
		<div class="code-section">
			<div class="code-label">// GLOBAL TOP</div>
			<div id="code-gt" class="code-editor">let helloWorld = true</div>
		</div>
		<div class="code-section">
			<div class="code-label">// SETUP</div>
			<div id="code-s" class="code-editor">let helloWorld = true</div>
		</div>
		<div class="code-section">
			<div class="code-label">// DRAW TOP</div>
			<div id="code-dt" class="code-editor">let helloWorld = true</div>
		</div>
		<div class="code-section">
			<div class="code-label">// DRAW BOTTOM</div>
			<div id="code-db" class="code-editor">let helloWorld = true</div>
		</div>
		<div class="code-section">
			<div class="code-label">// GLOBAL BOTTOM</div>
			<div id="code-gb" class="code-editor">let helloWorld = true</div>
		</div>
	</div> -->

<script type="text/javascript">
	/*
		TODO
			- redesign to match P5LIVE Snippet Editor panel (w/ color tweak)
			- import snippet (button, drag+drop)
			- x contribute snippet (init PR with json file?)
			- √√! iframe embed within P5LIVE with option to 'ADD'
	*/

	let getData = true
	let url = 'https://api.github.com/repos/ffd8/p5live_snippets/contents/snippets'
	let snippets = {
		snippet:{ name:'snippet', code:{ gt:'welcome to the SNIPPETS MANAGER, \na contributors repo of P5LIVE snippets \nto easily import into your own settings.', s:'', dt:'', db:'', gb:''}, }
	}
	let snippetsSize = 0, snippetsSel = -1

	let elms = {
		select: document.getElementById('select-snippet'),
		code:{
			gt:document.getElementById('snippets-code-gt'),
			s:document.getElementById('snippets-code-s'),
			dt:document.getElementById('snippets-code-dt'),
			db:document.getElementById('snippets-code-db'),
			gb:document.getElementById('snippets-code-gb'),
		},
	}

	let editors = {}

	const xhr = new XMLHttpRequest();

    xhr.open('GET', url, true);

    xhr.onload = function() {
        const data = JSON.parse(this.response);
        // console.log(data);
        snippetsSize = data.length
        for(let d of data){

        	// https://stackoverflow.com/a/71484399/10885535
        	(async() => {
			const res = await axios.get(d.download_url)
			let snippet = res.data
			// console.log(snippet)
			
			elms.select.innerHTML += `<option>${snippet.name}</option>`
			snippets[snippet.name] = snippet
			snippetsSize--
			
			// done loading
			if(snippetsSize == 0){
				loadTippy()
			}
			})()
        }
    };
    
    

    function getSnippet(snippet){
    	// console.log(snippets[snippet])
    	snippetsSel = snippet
    	editors.gt.setValue(snippets[snippet].code.gt, 1)
    	editors.s.setValue(snippets[snippet].code.s, 1)
    	editors.dt.setValue(snippets[snippet].code.dt, 1)
    	editors.db.setValue(snippets[snippet].code.db, 1)
    	editors.gb.setValue(snippets[snippet].code.gb, 1)
    }

    function snippetsToggle(){
    	parent.postMessage({msg:'toggle'}, "*");  //  `*` on any domain 
    }

    function applySnippet(){
    	parent.postMessage({msg:'apply', snippet: snippets[snippetsSel]}, "*");  //  `*` on any domain 
    }

    function addSnippet(){
    	parent.postMessage({msg:'add', snippet: snippets[snippetsSel]}, "*");  //  `*` on any domain     
    }

    function downloadSnippet(){
    	exportJSON(snippets[snippetsSel], `P5L_SNIPPET_${snippets[snippetsSel].name}.json`)
    }

    function exportJSON(jsonData, jsonFilename){
		const filename = jsonFilename;
		const jsonStr = JSON.stringify(jsonData, undefined, 2);

		let element = document.createElement('a');
		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(jsonStr));
		element.setAttribute('download', filename);
		element.style.display = 'none';
		document.body.appendChild(element);
		element.click();
		document.body.removeChild(element);
	}


    // SNIPPET CODE EDITORS
    let editorOptions = {
		showPrintMargin: false,
		animatedScroll: true,
		displayIndentGuides: false,
		useWorker: true,
		showLineNumbers: false,
		showGutter: false,
		scrollPastEnd:1,
		tabSize: 4, useSoftTabs: false,
	}

	function initSnippets(){
		for (const [key, value] of Object.entries(elms.code)) {
			editors[key] = ace.edit(elms.code[key]);
			editors[key].setTheme("ace/theme/gob");
			editors[key].getSession().setMode("ace/mode/javascript");
			editors[key].setOptions(editorOptions)
		}

		getSnippet('snippet')

		if(getData) xhr.send();
	}
	initSnippets()


	// P5LIVE UTILS
	// Tooltips via tippy
		function loadTippy(){
			
			tippy('.tippy', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title') // seems ok to leave there...
					return title
				},
				placement:'bottom',
				arrow:true,
				delay:0,
				duration:0,
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});

			tippy('.tippy-left', {
				content(reference) {
					const title = reference.getAttribute('data-title')
					//reference.removeAttribute('title')
					return title
				},
				placement:'left',
				arrow:true,
				delay:0,
				duration:0,
				zIndex:9999,
				boundary:'window',
				arrowType:'round',
				onShow(instance) {
					document.querySelectorAll('.tippy-popper').forEach(popper => {
						if (popper !== instance.popper) {
							popper._tippy.hide()
						}
					})
				}
			});
		}

		

</script>
</body>
</html>